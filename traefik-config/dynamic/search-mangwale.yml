http:
  routers:
    # HTTP to HTTPS Redirect
    search-redirect:
      rule: "Host(`search.test.mangwale.ai`)"
      entryPoints:
        - web
      service: noop@internal
      middlewares:
        - https-redirect

    # API Router (HTTPS)
    search-api:
      rule: "Host(`search.test.mangwale.ai`) && (PathPrefix(`/search`) || PathPrefix(`/analytics`) || PathPrefix(`/health`) || PathPrefix(`/docs`) || PathPrefix(`/api-docs`) || PathPrefix(`/v2`))"
      service: search-api-service
      entryPoints:
        - websecure
      priority: 10
      tls:
        certResolver: letsencrypt

    # Fix for Legacy Suggest Endpoint
    search-suggest-fix:
      rule: "Host(`search.test.mangwale.ai`) && PathPrefix(`/search/suggest`)"
      service: search-api-service
      entryPoints:
        - websecure
      priority: 20
      middlewares:
        - suggest-rewrite
      tls:
        certResolver: letsencrypt

    # Frontend Router (HTTPS)
    search-frontend:
      rule: "Host(`search.test.mangwale.ai`)"
      service: search-frontend-service
      entryPoints:
        - websecure
      priority: 1
      tls:
        certResolver: letsencrypt

  middlewares:
    https-redirect:
      redirectScheme:
        scheme: https
        permanent: true
    
    suggest-rewrite:
      replacePathRegex:
        regex: "^/search/suggest(.*)"
        replacement: "/v2/search/suggest$1"

  services:
    search-api-service:
      loadBalancer:
        servers:
          - url: "http://search-api:3100"

    search-frontend-service:
      loadBalancer:
        servers:
          - url: "http://search-frontend:80"
